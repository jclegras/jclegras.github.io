<!doctype html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  
    class="html theme--light"
  
><head>
  <meta charset="utf-8" />
  <title>
    Jean-Charles Legras
        |
        Le user namespace dans Docker
      

    

  </title>

  <meta name="generator" content="Hugo 0.145.0"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="Jean-Charles Legras" />
  <meta
    name="description"
    content="Call me JC"
  />
  
  
    
    
    <link
      rel="stylesheet"
      href="/scss/main.min.1cac29897bb941adf4246700acb99deffbfdf35a02ffc4ae81484456ebe430c3.css"
      integrity="sha256-HKwpiXu5Qa30JGcArLmd7/v981oC/8SugUhEVuvkMMM="
      crossorigin="anonymous"
      type="text/css"
    />
  

  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css"
    integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.137b1cf3cea9a8adb7884343a9a5ddddf4280f59153f74dc782fb7f7bf0d0519.css"
    integrity="sha256-E3sc886pqK23iENDqaXd3fQoD1kVP3TceC&#43;3978NBRk="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.e65dc5b48fb5f39b142360c57c3a215744c94e56c755c929cc3e88fe12aab4d3.css"
    integrity="sha256-5l3FtI&#43;185sUI2DFfDohV0TJTlbHVckpzD6I/hKqtNM="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.6f4f16d58da1c82c0c3a3436e021a3d39b4742f741192c546e73e947eacfd92f.css"
    integrity="sha256-b08W1Y2hyCwMOjQ24CGj05tHQvdBGSxUbnPpR&#43;rP2S8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.e10425ad768bc98ff1fb272a0ac8420f9d1ba22f0612c08ff1010c95080ffe7e.css"
    integrity="sha256-4QQlrXaLyY/x&#43;ycqCshCD50boi8GEsCP8QEMlQgP/n4="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png" />

  <link rel="canonical" href="https://jclegras.github.io/posts/le-user-namespace-dans-docker/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js"
    integrity="sha256-&#43;RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js"
      integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc="
      crossorigin="anonymous"
    ></script>
  

  

  


  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Le user namespace dans Docker">
  <meta name="twitter:description" content="Avant l’arrivée du user namespace dans Docker Lancement d’un conteneur Jenkins">



  
  <meta property="og:url" content="https://jclegras.github.io/posts/le-user-namespace-dans-docker/">
  <meta property="og:site_name" content="Jean-Charles Legras&#39; blog">
  <meta property="og:title" content="Le user namespace dans Docker">
  <meta property="og:description" content="Avant l’arrivée du user namespace dans Docker Lancement d’un conteneur Jenkins">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-06-01T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-06-01T00:00:00+00:00">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="Namespace">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Devops">



  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "posts",
        "name": "Le user namespace dans Docker",
        "headline": "Le user namespace dans Docker",
        "alternativeHeadline": "",
        "description": "
      
        \u003ch2 id=\u0022avant-larrivée-du-user-namespace-dans-docker\u0022\u003eAvant l\u0026rsquo;arrivée du user namespace dans Docker\u003c\/h2\u003e\n\u003cp\u003eLancement d\u0026rsquo;un conteneur Jenkins\u003c\/p\u003e


      


    ",
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/jclegras.github.io\/posts\/le-user-namespace-dans-docker\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Jean-Charles Legras"
        },
        "creator" : {
            "@type": "Person",
            "name": "Jean-Charles Legras"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Jean-Charles Legras"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Jean-Charles Legras"
        },
        "copyrightYear" : "2020",
        "dateCreated": "2020-06-01T00:00:00.00Z",
        "datePublished": "2020-06-01T00:00:00.00Z",
        "dateModified": "2020-06-01T00:00:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Jean-Charles Legras",
            "url": "https://jclegras.github.io/",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/jclegras.github.io\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/jclegras.github.io\/posts\/le-user-namespace-dans-docker\/",
        "wordCount" : "1908",
        "genre" : [ ],
        "keywords" : [ 
      
      "docker"

    
      
        ,

      
      "namespace"

    
      
        ,

      
      "linux"

    
      
        ,

      
      "devops"

    ]
    }
  </script>


</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/profile.webp"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">I&#39;m Jean-Charles Legras</a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>Call me JC</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://www.linkedin.com/in/jean-charles-legras-708b39a4/"
            target="_blank"
            rel="noopener me"
            aria-label="Linkedin"
            title="Linkedin"
          >
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/jclegras"
            target="_blank"
            rel="noopener me"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="mailto:jeancharles.legras@gmail.com"
            target="_blank"
            rel="noopener me"
            aria-label="e-mail"
            title="e-mail"
          >
            <i class="fa-solid fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Jean-Charles Legras
        2025
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR&#43;zwDAROtph0PXGte6ia8heboACF9R5l/DiY&#43;WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous" /><script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8&#43;w2LAIftJEULZABrF9PPFv&#43;tVkH" crossorigin="anonymous"></script><script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js"
      integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB&#43;w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v"
      crossorigin="anonymous"
      onload="renderMathInElement(document.body);"
    ></script></div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/posts/"
              
              title=""
              >Posts</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/about/"
              
              title=""
              >About</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      
        <h1>Le User Namespace Dans Docker</h1>
      
      <h2 id="avant-larrivée-du-user-namespace-dans-docker">Avant l&rsquo;arrivée du user namespace dans Docker</h2>
<p>Lancement d&rsquo;un conteneur Jenkins</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker run --name jenkins --d jenkins/jenkins:lts</span></span></code></pre></div>
<p>A quel utilisateur appartient le process à l&rsquo;intérieur du conteneur ?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ps -xao uid,cmd | grep jenkins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>UID  CMD
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1000</span> java <span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> -jar /usr/share/jenkins/jenkins.war</span></span></code></pre></div>
<p>L&rsquo;UID est fixé à <strong>jclegras</strong>, mon nom de login.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ grep <span style="color:#ae81ff">1000</span> /etc/passwd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jclegras:x:1000:1000:jclegras,,,:/home/jclegras:/bin/bash</span></span></code></pre></div>
<p>Essayons maintenant de lancer le conteneur avec l&rsquo;utilisateur root (option <em>-u</em>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker run -u root --name jenkins_root –d jenkins/jenkins:lts</span></span></code></pre></div>
<p>Encore une fois, regardons le résultat obtenu :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ps -xao uid,cmd | grep jenkins 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>UID CMD
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>   java <span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> -jar /usr/share/jenkins/jenkins.war</span></span></code></pre></div>
<p>Cette fois-ci le process appartient bien à l&rsquo;utilisateur <strong>root</strong>.</p>
<p>Une question s’impose alors d’elle-même: comment le docker engine
fait-il pour faire la correspondance entre les users de mes conteneurs,
et les users de la machine hôte, ou autrement dit, comment se fait-il
que le premier process appartienne à jclegras et le deuxième à root ?</p>
<h3 id="correspondance-des-users">Correspondance des users</h3>
<p>Pour le premier exemple, il faut regarder d’un peu plus près le <a href="https://github.com/jenkinsci/docker/blob/master/Dockerfile">Dockerfile de Jenkins</a>.</p>
<p>Les lignes qui nous intéressent sont :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-docker" data-lang="docker"><span style="display:flex;"><span><span style="color:#66d9ef">ARG</span> user<span style="color:#f92672">=</span>jenkins
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ARG</span> group<span style="color:#f92672">=</span>jenkins
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ARG</span> uid<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ARG</span> gid<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Jenkins is run with user `jenkins`, uid = 1000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># If you bind mount a volume from the host or a data container,</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ensure you use the same uid</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir -p $JENKINS_HOME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  <span style="color:#f92672">&amp;&amp;</span> chown <span style="color:#e6db74">${</span>uid<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>gid<span style="color:#e6db74">}</span> $JENKINS_HOME <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  <span style="color:#f92672">&amp;&amp;</span> groupadd -g <span style="color:#e6db74">${</span>gid<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>group<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  <span style="color:#f92672">&amp;&amp;</span> useradd -d <span style="color:#e6db74">&#34;</span>$JENKINS_HOME<span style="color:#e6db74">&#34;</span> -u <span style="color:#e6db74">${</span>uid<span style="color:#e6db74">}</span> -g <span style="color:#e6db74">${</span>gid<span style="color:#e6db74">}</span> -m -s /bin/bash <span style="color:#e6db74">${</span>user<span style="color:#e6db74">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> ${user}  </span></span></span></code></pre></div>
<p>Et voici ce que ça raconte : on crée un user et un group jenkins avec un uid
et un gid égales à 1000 puis on dit que, par défaut, en l’absence de user
explicite (l’option -u que nous avons fourni plus haut),
le process à l&rsquo;intérieur du conteneur s’exécutera avec les droits de
l’utilisateur <strong>jenkins</strong>.</p>
<p>Mais alors, comment se fait-il qu’un ps m’affirme que le conteneur
appartient à <em>jclegras</em> ?</p>
<p>A dire vrai, avant la <a href="https://www.docker.com/blog/docker-engine-1-10-security/">1.10</a>, Docker mappait exclusivement les users
(ou plus exactement les uid/gid) selon l’hôte:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jclegras uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>jclegras<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>jclegras<span style="color:#f92672">)</span></span></span></code></pre></div>
<p>C’est ainsi qu’on aperçoit le côté un peu tricky de la chose :
à l’intérieur du conteneur, par défaut, je suis le user jenkins mais
à l’extérieur, je suis mappé sur un user qui <strong>correspond à</strong> jenkins,
c’est-à-dire à quelqu’un possédant ses identifiants :</p>
<pre tabindex="0"><code>uid=1000(jenkins) gid=1000(jenkins) groups=1000(jenkins)
</code></pre><p>Autrement dit, l’utilisateur jenkins est en réalité l’utilisateur
jclegras sur la machine hôte !</p>
<p>Par extension, lorsque j’ai lancé mon deuxième conteneur en tant que
root, l’utilisateur root du conteneur était en réalité l’utilisateur
correspondant aux identifiants (uid/gid) de root :</p>
<pre tabindex="0"><code>uid=0(root) gid=0(root) groups=0(root)
</code></pre><p>Et je ne vous apprends rien en disant que ce sont exactement les même
identifiants que le user root de la machine hôte.</p>
<p>Le root du conteneur est donc mappé sur le root de l’hôte !</p>
<p><strong>C’est pourquoi, dans les bonnes pratiques de Docker, il est conseillé
de lancer vos conteneurs sous un autre utilisateur que root</strong>
(ce qu’ont bien compris les concepteurs de l’image Jenkins).</p>
<h3 id="le-danger-de-la-correspondance-des-users-par-défaut">Le danger de la correspondance des users par défaut</h3>
<p>Imaginons que je suive donc les best practices et que je lance le
conteneur Jenkins avec l&rsquo;utilisateur jenkins comme dans le premier
exemple.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -name jenkins -d jenkins</span></span></code></pre></div>
<p>Rien ne m’empêche par la suite de rentrer à l’intérieur avec
l’utilisateur root (il y a toujours un utilisateur root disponible dans les conteneurs) :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker exec -u root -it jenkins bash</span></span></code></pre></div>
<p>Vous me direz que ce n’est rien, après tout, tout ce que je peux faire
dans le conteneur reste dans le conteneur, et c’est le but d’un tel outil.</p>
<p><strong>Que se passe-t-il lorsque nous commençons à monter des volumes ?</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>/jenkins_home:/var/jenkins_home -d jenkins</span></span></code></pre></div>
<p>Ou plus généralement :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -v /répertoire_critique:/opt/dest -d jenkins</span></span></code></pre></div>
<p>Vous imaginez dès lors les conséquences d’une prise de contrôle de la
part d’un utilisateur malveillant sur, par exemple, une application web
(ou pire une base de données) ayant au moins un volume partagé :
on peut tout supprimer. Et si mon “répertoire_critique” contient
d’autres fichiers que ceux exigés par l’application web, je peux aussi
les modifier et mettre en péril, dans le pire des cas, <strong>l’ensemble
de mon système hôte</strong> (pas génial si vous êtes en prod…).</p>
<p>L’idéal serait d’avoir un système permettant de cloisonner
ces utilisateurs dans le conteneur afin que, même si je suis root à
l’intérieur du conteneur (et que je puisse donc faire tout ce que bon me semble),
je ne puisse pas mettre en danger le système hôte.</p>
<p>De la même façon, même si j’utilise un utilisateur custom dans mon conteneur,
je voudrais ne pas correspondre à un user random sur le système hôte
(même si dans les faits, pour éviter que jenkins corresponde à jclegras,
on fait en sorte d’attribuer des uid et des gid plus élevés afin de faire
correspondre jenkins au “vrai” user jenkins sur l’hôte créé pour l’occasion).</p>
<p>Cependant, et vous vous en doutez, il faut aller bidouiller les différents
Dockerfiles de toutes ces images officielles et procéder nous-même aux modifications qui vont bien,
tout en répercutant sur le système hôte, et en espérant que mon user
jenkins ne se voit pas, un beau jour, attribuer des privilèges qu’il ne mérite pas
(tiens, pourquoi jenkins est dans les sudoers d’un seul coup ?)</p>
<h2 id="le-user-namespace-dans-docker">Le user namespace dans Docker</h2>
<p>Bref, c’est ici que le user namespace finalement intégré au Docker engine
(bien que présent depuis quelque temps dans le noyau linux) arrive à la rescousse.</p>
<p>Succinctement, cette feature permet de mapper (dynamiquement) mes users comme suit :</p>
<pre tabindex="0"><code>root -&gt; un user_non_privilégié
jenkins -&gt; un autre_user_non_privilégié ...
</code></pre><p>En pratique, voici comment le mettre en application : <a href="https://docs.docker.com/engine/security/userns-remap/">https://docs.docker.com/engine/security/userns-remap/</a></p>
<p>Je ne sais pas si c’est très clair, mais essayons de “singer” ce tuto en partant d’un besoin réel :</p>
<ul>
<li>Je souhaite que tous mes conteneurs s’exécutant sous root soient mappés sur le user et le groupe <em>dockremap</em> ;</li>
<li>Je souhaite également que les conteneurs utilisant un utilisateur personnalisé d’UID 1000
et appartenant à un groupe de GID 1000 soient mappés sur l’utilisateur et le groupe <em>dockremap-user</em> ;</li>
<li>Finalement, je souhaite que les users/groupes dockremap et dockremap-user possèdent le moins de droits possible.</li>
</ul>
<p>Commençons par l’étape de création des utilisateurs et des groupes :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>groupadd -g <span style="color:#ae81ff">500000</span> dockremap <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> groupadd -g <span style="color:#ae81ff">501000</span> dockremap-user <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> useradd -u <span style="color:#ae81ff">500000</span> -g dockremap -s /bin/false dockremap <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> useradd -u <span style="color:#ae81ff">501000</span> -g dockremap-user -s /bin/false dockremap-user</span></span></code></pre></div>
<p>Ensuite, ajoutons une liste d’utilisateurs “subalternes” et une liste
de groupes “subalternes” en utilisant comme point de référence, resp.,
l’utilisateur et le groupe dockremap :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;dockremap:500000:65536&#34;</span> &gt;&gt; /etc/subuid <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> echo <span style="color:#e6db74">&#34;dockremap:500000:65536&#34;</span> &gt;&gt; /etc/subgid</span></span></code></pre></div>
<p>Finalement, ajoutons l’option magique <strong>userns-remap</strong> pour activer le user namespace dans les conteneurs
(passons par le fichier de conf du démon docker pour l’occasion) :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;userns-remap&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span> }</span></span></code></pre></div>
<p>On remarquera que default est un alias de <em>dockremap</em> :
en fait, quand on met <em>default</em>, le démon docker crée (si ce n’est pas déjà fait),
un utilisateur et un groupe dockremap (avec un “numerical subordinate user/group ID”
positionné à un offset correspondant à ce qui était déjà présent dans les fichiers
<em>/etc/subuid</em> et <em>/etc/subgid</em> lors de la création).</p>
<p>On aurait donc pu se passer des étapes précédentes,
mais on y gagne au moins deux choses : nous avons choisi nos propres ID (500000 dans les deux cas) et on sait le faire manuellement.</p>
<p>Pour finir, redémarrons le démon docker :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart docker</span></span></code></pre></div>
<p>Mission accomplie, nos users sont bien mappés comme nous le voulions !</p>
<p>En fait, en s’appuyant sur les utilisateur et groupe de référence dockremap
fixés tout deux à 500000 et sur la configuration des “subordinate files“ (les <em>/etc/sub*</em>),
le mapping sera comme suit:</p>
<table>
  <thead>
      <tr>
          <th>ID machine hôte |</th>
          <th style="text-align: left">ID conteneur</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>500000</td>
          <td style="text-align: left">0</td>
      </tr>
      <tr>
          <td>501000</td>
          <td style="text-align: left">1000</td>
      </tr>
      <tr>
          <td>&hellip;</td>
          <td style="text-align: left">&hellip;</td>
      </tr>
      <tr>
          <td>565536</td>
          <td style="text-align: left">65536</td>
      </tr>
  </tbody>
</table>
<p>On peut donc dès lors se contenter d’utiliser root dans tous nos conteneurs
puisque ce dernier sera automatiquement converti en dockremap sur l’hôte,
tout en gardant les avantages d’être root, et donc tout puissant, à l’intérieur de nos conteneurs.</p>
<h2 id="bonus">Bonus</h2>
<p>Cette section est créée en guise d’avertissement.</p>
<p>Avant, lorsque nous étions root dans nos conteneurs, on pouvait monter très simplement nos volumes partagés
(j’entends par là : entre le système hôte et le conteneur cible) :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -v /mon_repertoire:/mon_repertoire -d <span style="color:#f92672">[</span>mon_image<span style="color:#f92672">]</span></span></span></code></pre></div>
<p>Et je pouvais faire ce que je voulais sur les fichiers contenus dans
<strong>mon_repertoire</strong> (les modifier, les supprimer…).</p>
<p>En effet, rappelez-vous, root du conteneur était mappé sur root de l’hôte
et par conséquent, il avait tous les droits.</p>
<p>Comment faire dès lors pour pouvoir modifier les fichiers contenus dans
le répertoire lorsque j’active le user namespace et que mon user root est mappé sur dockremap ?</p>
<p>C&rsquo;est très simple, il vous faudra attribuer les droits qui vont bien aux fichiers en question :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R dockremap:dockremap /mon_repertoire/</span></span></code></pre></div>
<p>Voici une démo qui montre que ça fonctionne pas trop mal :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -l test_docker/ 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> dockremap dockremap <span style="color:#ae81ff">0</span> sept. <span style="color:#ae81ff">4</span> 01:01 dummy_dockremap 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> dockremap-user dockremap-user <span style="color:#ae81ff">0</span> sept. <span style="color:#ae81ff">4</span> 01:00 dummy_dockremap-user 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> jclegras jclegras <span style="color:#ae81ff">12</span> sept. <span style="color:#ae81ff">3</span> 16:29 dummy_jclegras 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> jenkins jenkins <span style="color:#ae81ff">12</span> sept. <span style="color:#ae81ff">2</span> 00:59 dummy_jenkins 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">0</span> sept. <span style="color:#ae81ff">2</span> 00:28 dummy_root </span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker run -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>/test_docker:/var/jenkins_home/test_docker -d jenkins 
</span></span><span style="display:flex;"><span>070003aa39b81a53ffe6b01f44986922058f1585d8da285f981cf3b673b9d734 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker exec -it <span style="color:#ae81ff">070</span> bash 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jenkins@070003aa39b8:/$ ls -l /var/jenkins_home/test_docker/ 
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">0</span> Sep <span style="color:#ae81ff">3</span> 23:01 dummy_dockremap 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> jenkins jenkins <span style="color:#ae81ff">0</span> Sep <span style="color:#ae81ff">3</span> 23:00 dummy_dockremap-user 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> nobody nogroup <span style="color:#ae81ff">12</span> Sep <span style="color:#ae81ff">3</span> 14:29 dummy_jclegras 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> nobody nogroup <span style="color:#ae81ff">12</span> Sep <span style="color:#ae81ff">1</span> 22:59 dummy_jenkins 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> nobody nogroup <span style="color:#ae81ff">0</span> Sep <span style="color:#ae81ff">1</span> 22:28 dummy_root 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jenkins@070003aa39b8:/$ whoami 
</span></span><span style="display:flex;"><span>jenkins 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jenkins@070003aa39b8:/$ id 
</span></span><span style="display:flex;"><span>jenkins uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>jenkins<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>jenkins<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>jenkins<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jenkins@070003aa39b8:/$ echo <span style="color:#e6db74">&#34;hello world&#34;</span>&gt;&gt; /var/jenkins_home/test_docker/dummy_dockremap 
</span></span><span style="display:flex;"><span>bash: /var/jenkins_home/test_docker/dummy_dockremap: Permission denied 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jenkins@070003aa39b8:/$ echo <span style="color:#e6db74">&#34;hello world&#34;</span> &gt;&gt; /var/jenkins_home/test_docker/dummy_dockremap-user 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jenkins@070003aa39b8:/$ echo <span style="color:#e6db74">&#34;hello world&#34;</span> &gt;&gt; /var/jenkins_home/test_docker/dummy_dockremap-jclegras 
</span></span><span style="display:flex;"><span>bash: /var/jenkins_home/test_docker/dummy_dockremap-jclegras: Permission denied 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jenkins@070003aa39b8:/$ echo <span style="color:#e6db74">&#34;hello world&#34;</span> &gt;&gt; /var/jenkins_home/test_docker/dummy_dockremap-jenkins 
</span></span><span style="display:flex;"><span>bash: /var/jenkins_home/test_docker/dummy_dockremap-jenkins: Permission denied 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jenkins@070003aa39b8:/$ echo <span style="color:#e6db74">&#34;hello world&#34;</span> &gt;&gt; /var/jenkins_home/test_docker/dummy_dockremap-root 
</span></span><span style="display:flex;"><span>bash: /var/jenkins_home/test_docker/dummy_dockremap-root: Permission denied</span></span></code></pre></div>
<p>En utilisant root dans mon conteneur :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker exec -u root -it <span style="color:#ae81ff">070</span> bash 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@070003aa39b8:/# ls -l 
</span></span><span style="display:flex;"><span>/var/jenkins_home/test_docker/ 
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">0</span> Sep <span style="color:#ae81ff">3</span> 23:01 dummy_dockremap 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> jenkins jenkins <span style="color:#ae81ff">12</span> Sep <span style="color:#ae81ff">3</span> 23:07 dummy_dockremap-user 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> nobody nogroup <span style="color:#ae81ff">12</span> Sep <span style="color:#ae81ff">3</span> 14:29 dummy_jclegras 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> nobody nogroup <span style="color:#ae81ff">12</span> Sep <span style="color:#ae81ff">1</span> 22:59 dummy_jenkins 
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> nobody nogroup <span style="color:#ae81ff">0</span> Sep <span style="color:#ae81ff">1</span> 22:28 dummy_root 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@070003aa39b8:/# id <span style="color:#e6db74">`</span>whoami<span style="color:#e6db74">`</span> 
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@070003aa39b8:/# echo <span style="color:#e6db74">&#34;hello world&#34;</span> &gt;&gt; /var/jenkins_home/test_docker/dummy_dockremap 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@070003aa39b8:/# echo <span style="color:#e6db74">&#34;hello world&#34;</span> &gt;&gt; /var/jenkins_home/test_docker/dummy_dockremap-user 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@070003aa39b8:/# echo <span style="color:#e6db74">&#34;hello world&#34;</span> &gt;&gt; /var/jenkins_home/test_docker/dummy_jclegras 
</span></span><span style="display:flex;"><span>bash: /var/jenkins_home/test_docker/dummy_jclegras: Permission denied 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@070003aa39b8:/# echo <span style="color:#e6db74">&#34;hello world&#34;</span> &gt;&gt; /var/jenkins_home/test_docker/dummy_jenkins 
</span></span><span style="display:flex;"><span>bash: /var/jenkins_home/test_docker/dummy_root: Permission denied</span></span></code></pre></div>
<p>Et enfin, en regardant la table des processus (avec le conteneur lancé avec le user par défaut, jenkins) :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ps aux | grep dock 
</span></span><span style="display:flex;"><span>dockrem+ <span style="color:#ae81ff">16807</span> 0.0 0.0 <span style="color:#ae81ff">1112</span> <span style="color:#ae81ff">4</span> ? Ss 01:03 0:00 /bin/tini -- /usr/local/bin/jenkins.sh 
</span></span><span style="display:flex;"><span>dockrem+ <span style="color:#ae81ff">16825</span> 2.3 5.2 <span style="color:#ae81ff">3073244</span> <span style="color:#ae81ff">213492</span> ? Sl 01:03 0:17 java -jar /usr/share/jenkins/jenkins.war 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ps -U dockremap-user 
</span></span><span style="display:flex;"><span>PID TTY TIME     CMD 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16807</span> ? 00:00:00 tini
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16825</span> ? 00:00:17 java</span></span></code></pre></div>
<h2 id="ressources">Ressources</h2>
<p>Le user namespace en long, en large et en travers :</p>
<ul>
<li><a href="https://docs.docker.com/engine/security/userns-remap">Configuration du user namespace sous Docker</a></li>
<li><a href="https://lwn.net/Articles/532593/">Article LWN.net sur le user namespace</a></li>
<li><a href="https://docs.docker.com/engine/security/userns-remap/#user-namespace-known-limitations">Restrictions inhérentes à l’activation du user namespace</a></li>
</ul>
<p>Les namespaces du kernel linux, fondations des conteneurs (mais pas que) :</p>
<ul>
<li><a href="https://www.man7.org/linux/man-pages/man7/user_namespaces.7.html">Les namespaces en général sous Linux</a></li>
<li><a href="https://www.toptal.com/linux/separation-anxiety-isolating-your-system-with-linux-namespaces">Un autre article sur les namespaces du kernel linux</a></li>
</ul>
<p>Bonnes pratiques Docker :</p>
<ul>
<li><a href="https://w3blog.fr/2016/02/23/docker-securite-10-bonnes-pratiques/">10 bonnes pratiques</a></li>
</ul>
<p>J&rsquo;espère que ce billet vous a plu et qu&rsquo;il vous donne envie de creuser
le sujet plus en profondeur (Docker, les namespaces linux, les cgroups, les fondations des conteneurs&hellip;).</p>
<p>Merci pour votre lecture.</p>
</div>
    <div class="post__footer">
      

      
        <span><a class="tag" href="/tags/docker/">docker</a><a class="tag" href="/tags/namespace/">namespace</a><a class="tag" href="/tags/linux/">linux</a><a class="tag" href="/tags/devops/">devops</a></span>


      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Jean-Charles Legras
        2025
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR&#43;zwDAROtph0PXGte6ia8heboACF9R5l/DiY&#43;WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous" /><script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8&#43;w2LAIftJEULZABrF9PPFv&#43;tVkH" crossorigin="anonymous"></script><script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js"
      integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB&#43;w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v"
      crossorigin="anonymous"
      onload="renderMathInElement(document.body);"
    ></script></body>
</html>
